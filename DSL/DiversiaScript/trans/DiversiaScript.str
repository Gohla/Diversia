module DiversiaScript

imports
  libstratego-lib
  libstratego-gpp
  libstratego-aterm
  include/DiversiaScript
  lib/editor-common.generated
  rename
  store
  desugar
  codegen/lua/luagen
  
  lib/namespaces
  namespace
  
strategies
	
	analyse-all = desugar-all; store-all

rules // Main editor interface (defined by editor/DiversiaScript-Builders and -References.esv)
  
// Analyzes the current program, returning a tuple with errors, warnings, and notes;
// each a list of (term, message) tuples or simply (message) terms.
editor-analyze: (ast, path, project-path) -> (ast, errors, warnings, notes)
	with
    	editor-init;
      	errors   := <fail> ast;
      	warnings := <fail> ast;
      	notes    := <fail> ast
  
  // Transforms a selection to Lua
generate-lua: (selected, position, ast, path, project-path) -> (filename, result)
	with
    {| Declared, Referred:
    	filename := <guarantee-extension(|"lua")> path;
    	result   := <lua-tostring> <to-lua> <analyse-all> selected
    |}
generate-lua-aterm: (selected, position, ast, path, project-path) -> (filename, result)
	with 
    {| Declared, Referred:
    	filename := <guarantee-extension(|"aterm")> path;
      	result   := <to-lua> <analyse-all> selected
	|}
	
// Transforms a selection to C++
generate-cpp: (selected, position, ast, path, project-path) -> (filename, result)
	with
    {| Declared, Referred:
    	filename := <guarantee-extension(|"cpp")> path;
    	result   := ""
  	|}
  	
// Prints the abstract syntax ATerm of a selection.
generate-aterm: (selected, position, ast, path, project-path) -> (filename, result)
	with 
    {| Declared:
		filename := <guarantee-extension(|"aterm")> path;
		result   := <analyse-all> selected
	|}